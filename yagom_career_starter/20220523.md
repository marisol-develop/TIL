# TIL(2022.05.23)

> date: 2022.05.23</br>
> ì§„í–‰ì¤‘ì¸ í”„ë¡œì íŠ¸: ios-open-market
> í™œë™í•™ìŠµ ì£¼ì œ: Understanding swift performance

## ğŸ‘©ğŸ»â€ğŸ’»í•™ìŠµë‚´ìš©

## Understanding swift performance

class vs struct ë¿ë§Œ ì•„ë‹ˆë¼ protocol, generic ë“± ì˜¬ë°”ë¥¸ ì¶”ìƒí™” ë©”ì»¤ë‹ˆì¦˜ì— ëŒ€í•œ ì„ íƒê³¼ ì„±ëŠ¥ì— ëŒ€í•œ ì´í•´!

![](https://i.imgur.com/ZwPHMOr.png)

> **ì¶”ìƒí™” ê¸°ë²•ì„ ì„ íƒí•  ë•Œ ê³ ë ¤í•´ì•¼ í•  3ê°€ì§€ ì¸¡ë©´**
> 1. allocation (stack vs heap)
    > ì¸ìŠ¤í„´ìŠ¤ê°€ ë©”ëª¨ë¦¬ì— í• ë‹¹ë ë•Œ stackì— ì €ì¥ë ê²ƒì¸ê°€ heapì— ì €ì¥ë  ê²ƒì¸ê°€?
> 2. reference counting (less vs more)
    > ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì£¼ê³  ë°›ì„ ë•Œ ì–¼ë§ˆë‚˜ ë§ì€ reference counting ì˜¤ë²„í—¤ë“œê°€ ë°œìƒí•˜ëŠ”ê°€?
> 3. method dispatch (static vs dynamic)
    > methodë¥¼ í˜¸ì¶œí•  ë•Œ static dispatchê°€ ë ê¹Œ dynamic dispatchê°€ ë ê¹Œ?

ë¹ ë¥´ê²Œ ë™ì‘í•˜ëŠ” ì½”ë“œë¥¼ ì‘ì„±í•˜ë ¤ë©´, í™œìš©í•˜ì§€ ì•ŠëŠ” dynamismê³¼ runtimeì— ëŒ€í•œ ë¹„ìš©ì„ ì§€ë¶ˆí•˜ì§€ ì•Šì•„ì•¼ í•œë‹¤


### ğŸ“Œ Allocation

#### Stack
- ê°„ë‹¨í•œ ë°ì´í„° êµ¬ì¡°. stackì˜ ëìœ¼ë¡œ pushí•˜ê³  stackì˜ ëì—ì„œ popí•  ìˆ˜ ìˆë‹¤
- stack ëì—ì„œë§Œ ì¶”ê°€í•˜ê±°ë‚˜ ì œê±°í•  ìˆ˜ ìˆë‹¤ (LIFO)
- stack ëì— ìˆëŠ” í¬ì¸í„°ë¥¼ stack pointerë¼ê³  í•œë‹¤
- í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•  ë•Œ ê³µê°„ì„ ë§Œë“¤ê¸° ìœ„í•´ stack pointerë¥¼ ì•½ê°„ ê°ì†Œì‹œí‚¤ëŠ” ê²ƒë§Œìœ¼ë¡œ í•„ìš”í•œ ë©”ëª¨ë¦¬ë¥¼ í• ë‹¹í•  ìˆ˜ ìˆë‹¤ (Decrement stack pointer to allocate)
- í•¨ìˆ˜ ì‹¤í–‰ì´ ëë‚˜ë©´ stack pointerë¥¼ ì´ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ê¸° ì „ì˜ ìœ„ì¹˜ë¡œ ë‹¤ì‹œ ì¦ê°€ì‹œì¼œ ë©”ëª¨ë¦¬ í• ë‹¹ì„ ê°„ë‹¨í•˜ê²Œ í•´ì œí•  ìˆ˜ ìˆë‹¤ (Increment stack pointer to deallocate)
- stackì˜ í• ë‹¹ì€ ì™„ì „ ë¹ ë¦„!

#### Heap
- heapì€ stackë³´ë‹¤ ë™ì ì´ì§€ë§Œ íš¨ìœ¨ì„±ì´ ë–¨ì–´ì§„ë‹¤
- heapì€ dynamic lifetimeì„ ê°€ì§„ ë©”ëª¨ë¦¬ë¥¼ í• ë‹¹í•  ìˆ˜ ìˆì§€ë§Œ, stackì€ ë¶ˆê°€ëŠ¥í•˜ë‹¤
    - ì´ë¥¼ êµ¬í˜„í•˜ê¸° ìœ„í•´ì„œëŠ” advanced data structureê°€ í•„ìš”í•˜ë‹¤
- heapì— ë©”ëª¨ë¦¬ë¥¼ í• ë‹¹í•˜ë ¤ë©´ ì ì ˆí•œ í¬ê¸°ì˜ â€œì‚¬ìš©ë˜ì§€ ì•Šì€ ë¸”ëŸ­â€ì„ ê²€ìƒ‰í•´ì„œ ì°¾ì•„ì•¼ í•œë‹¤
- ì‘ì—…ì´ ëë‚œë’¤ í• ë‹¹ì„ í•´ì œí•˜ë ¤ë©´ í•´ë‹¹ ë©”ëª¨ë¦¬ë¥¼ ì ì ˆí•œ ìœ„ì¹˜ì— ë‹¤ì‹œ ì‚½ì…í•´ì•¼ í•œë‹¤
    - ê²€ìƒ‰í•˜ê³  ì¬ì‚½ì…í•˜ê³ ,, stackë³´ë‹¤ ë³µì¡í•˜ë‹¤
- ì—¬ëŸ¬ ìŠ¤ë ˆë“œê°€ ë™ì‹œì— heapì— ë©”ëª¨ë¦¬ë¥¼ í• ë‹¹í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, heapì€ lockë˜ëŠ” ê¸°íƒ€ ë™ê¸°í™” ë©”ì»¤ë‹ˆì¦˜ì„ ì‚¬ìš©í•˜ì—¬ ë¬´ê²°ì„±ì„ ë³´í˜¸í•´ì•¼ í•˜ëŠ”ë°, ì´ê²Œ heap í• ë‹¹ì—ì„œ ê°€ì¥ í° ë¹„ìš©!!
    - stackì€ ìŠ¤ë ˆë“œë³„ë¡œ êµ¬ì„±ë˜ê¸° ë•Œë¬¸ì— ì‹ ê²½ì“°ì§€ ì•Šì•„ë„ ëœë‹¤
- heapì´ ìŠ¤ë ˆë“œ ì„¸ì´í”„ í•˜ì§€ ì•Šì€ ì´ìœ ? ëŒ€ì²´ì ìœ¼ë¡œ ì°¸ì¡°íƒ€ì…(class, closure, ì¼ë¶€ struct (stringê°™ì€ê±°)) ì´ heap ì˜ì—­ì„ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì—

ê·¸ë˜ì„œ í”„ë¡œê·¸ë¨ì—ì„œ ë©”ëª¨ë¦¬ë¥¼ í• ë‹¹í•˜ëŠ” ì¥ì†Œ(Stack or Heap)ë¥¼ ì¡°ê¸ˆ ë” ì‹ ì¤‘íˆ ìƒê°í•˜ë©´, ì„±ëŠ¥ì´ í¬ê²Œ í–¥ìƒë  ìˆ˜ ìˆë‹¤~!~!~!~!

### ğŸ“Œ Reference Counting

swiftëŠ” heapì— í• ë‹¹ëœ ë©”ëª¨ë¦¬ë¥¼ í• ë‹¹ í•´ì œí•˜ëŠ” ê²ƒì´ ì•ˆì „í•˜ë‹¤ëŠ” ê²ƒì„ ì–´ë–»ê²Œ ì•Œìˆ˜ìˆì„ê¹Œ?
-> swiftê°€ heapì— ìˆëŠ” ì¸ìŠ¤í„´ìŠ¤ì— ëŒ€í•œ ì´ ë ˆí¼ëŸ°ìŠ¤ ì¹´ìš´íŠ¸ë¥¼ ìœ ì§€í•œë‹¤

ë ˆí¼ëŸ°ìŠ¤ë¥¼ ì¶”ê°€í•˜ê±°ë‚˜ ì œê±°í•˜ë©´, í•´ë‹¹ ë ˆí¼ëŸ°ìŠ¤ ì¹´ìš´íŠ¸ê°€ ì¦ê°€ / ê°ì†Œí•œë‹¤
ì´ ì¹´ìš´íŠ¸ê°€ 0ì´ ë˜ë©´ swiftëŠ” ì•„ë¬´ë„ heapì—ì„œ ì´ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ê°€ë¦¬í‚¤ê³  ìˆì§€ ì•Šìœ¼ë©°, ë©”ëª¨ë¦¬ë¥¼ í• ë‹¹ í•´ì œí•˜ëŠ” ê²ƒì´ ì•ˆì „í•˜ë‹¤ëŠ” ê²ƒì„ ì•Œê²Œ ëœë‹¤

Stringì€ structì§€ë§Œ, contentsë¥¼ heapì— ì €ì¥í•˜ê¸° ë•Œë¬¸ì— reference countê°€ ë°œìƒí•œë‹¤

**struct ë‚´ë¶€ì— reference typeì´ ìˆëŠ” ê²½ìš°**, reference ìˆ˜ì— ë¹„ë¡€í•˜ì—¬ reference counting  ì˜¤ë²„í—¤ë“œë¥¼ ì§€ë¶ˆí•˜ê²Œ ë˜ë©°, *ë‘˜ ì´ìƒì˜ reference ê°€ ìˆëŠ” ê²½ìš°, classë³´ë‹¤ reference counting ì˜¤ë²„í—¤ë“œê°€ ë” ë§ì´ ìœ ì§€ëœë‹¤*

=> ë¬´ì¡°ê±´ structê°€ ë‹µì€ ì•„ë‹ˆë‹¤!ğŸ¥² (ê·¸ë™ì•ˆ ë‚œ ë­˜í•œê±°ì§€..)

![](https://i.imgur.com/pASkbso.png)

(ì´ë”°êµ¬ë¡œ ëœë‹¤ê³  í•œë‹¤ã… ã… )

enum ë“±ì„ í™œìš©í•´ì„œ struct ë‚´ë¶€ì— string ì‚¬ìš©ì„ ëŒ€ì²´í•  ìˆ˜ ìˆë‹¤!

### ğŸ“Œ Method Dispatch

- static dispatch: ì»´íŒŒì¼íƒ€ì„ì— (ëŸ°íƒ€ì„ ì•„ë‹˜ ì£¼ì˜) ì–´ë–¤ êµ¬í˜„ì„ ì‹¤í–‰í• ê±´ì§€ ê²°ì •í•  ìˆ˜ ìˆë‹¤
- dynamic dispatch: ì»´íŒŒì¼íƒ€ì„ì— ì–´ë–¤ êµ¬í˜„ì„ ì‹¤í–‰í• ê±´ì§€ ê²°ì •í•  ìˆ˜ ì—†ë‹¤ (ëŸ°íƒ€ì„ ë•Œë§Œ ì‹¤ì œë¡œ êµ¬í˜„ëœ ê³³ìœ¼ë¡œ ì í”„í•œë‹¤)
=> dynamic dispatchì˜ ë¹„ìš©ì€ static dispatchì˜ ë¹„ìš©ë³´ë‹¤ í›¨ì”¬ í¬ë‹¤

ê·¸ë ‡ë‹¤ë©´ dynamic dispatchë¥¼ ì“°ëŠ” ì´ìœ ëŠ”?!
=> ë‹¤í˜•ì„± (polymorphism) ë•Œë¬¸ì—

![](https://i.imgur.com/x4x7RnJ.png)

ğŸ˜µâ€ğŸ’« **ì»´íŒŒì¼ëŸ¬ëŠ” ì–´ë–¤ ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ëŠ”ì§€ ì–´ë–»ê²Œ ê²°ì •í• ê¹Œ?**

ì»´íŒŒì¼ëŸ¬ëŠ” í´ë˜ìŠ¤ì— í•„ë“œë¥¼ í•˜ë‚˜ ë” ì¶”ê°€í•˜ëŠ”ë° ì´ í•„ë“œëŠ” **í´ë˜ìŠ¤ì˜ íƒ€ì… ì •ë³´ì— ëŒ€í•œ í¬ì¸í„°**ì´ë©°, íƒ€ì… ì •ë³´ëŠ” **static memory**ì— ì €ì¥ë˜ì–´ ìˆë‹¤
ë©”ì„œë“œë¥¼ í˜¸ì¶œí•  ë•Œ, ì»´íŒŒì¼ëŸ¬ëŠ” static memoryì— ìˆëŠ” íƒ€ì… ì •ë³´ë¥¼ ë³´ê³  **ì‹¤í–‰ë˜ì–´ì•¼ í•  êµ¬í˜„ë¶€ë¥¼ ê°€ë¦¬í‚¤ëŠ” í¬ì¸í„°ê°€ ìˆëŠ” virtual method table(v-table)** ë¥¼ í†µí•´ ë©”ì„œë“œë¥¼ í˜¸ì¶œí•œë‹¤
ê·¸ë¦¬ê³  ì‹¤í–‰í•˜ê¸°ì— ì ì ˆí•œ ë©”ì„œë“œë¥¼ ì°¾ê³ , ê·¸ë¦¬ê³ ë‚˜ì„œ íŒŒë¼ë¯¸í„°ë¡œ ì‹¤ì œ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì „ë‹¬í•œë‹¤

classì—ì„œ dynamic dispatchë¥¼ ì‚¬ìš©í•˜ê³  ì‹¶ì§€ ì•Šìœ¼ë©´ finalë¡œ ëª…ì‹œí•œë‹¤ -> static dispatch

v-tableì€ ìƒì†ê´€ê³„ì—ì„œ ì‚¬ìš©í•˜ê³ , í”„ë¡œí† ì½œì—ì„œëŠ” pwt(protocol witness table)ë¥¼ ì‚¬ìš©í•œë‹¤

pwtë‘ vwtëŠ” ë‹¤ìŒ ì´ì‹œê°„ì—â€¦

---
ì°¸ê³ ìë£Œ
- https://developer.apple.com/videos/play/wwdc2016/416/
- https://zeddios.tistory.com/596
- https://corykim0829.github.io/swift/Understanding-Swift-Performance/#
